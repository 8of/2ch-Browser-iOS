# 2ch makaba API

Большинство работы с makaba API осуществляется через JSON, обращениями по SSL протоколу.
Исключения, будут обговорены в каждом конкретном случае.

## Список досок

http://2ch.hk/makaba/mobile.fcgi?task=get_boards


## Получение списка тредов для доски

https://2ch.hk/board/page.json

**board** - код доски (b, soc и т.д.)

**page** - номер страницы

Максимальное количество страниц для каждой доски разное, этот парамтер передаётся в ответе на запрос списка досок вместе с названием и кратким кодом.
Если страница - начальная, то в PAGE стоит подставить ключевое слово **index**.


## Получение списка сообщений для треда

https://2ch.hk/board/res/thread_num.json

**board** - код доски (b, soc и т.д.)

**thread_num** - числовой номер сообщения ОП-поста треда (можно получить в списке тредов для доски).


## Отправка сообщения в тред / создание треда

https://2ch.hk/makaba/posting.fcgi

Параметры для передачи:

+ json = **1**
+ task = **post**
+ board - *код доски*
+ thread - *номер треда* - для создания нового треда необходимо проставить **0**
+ email - *значение поля e-mail*
+ name - *имя*
+ subject - *тема сообщения*
+ comment - *комментарий*, максимальное количество символов - *15000*
+ image - *изображение для отправки*
+ captcha-key - *ключ капчи для проверки* - можно получить через отдельный метод. Для Яндекс-капчи он описан ниже.
+ captcha_value - *разгаданные символы капчи* - для Яндекс-капчи - цифры
+ usercode - *код для определения пасскода* - можно получить через отдельный метод

Параметр **usercode** и связка параметров **captcha-key + captcha_value** являются взаимоисключающими.

При использовании их одновременно положительный ответ сервера не гарантирован.

Если используется что-то одно, то второе обязательно должно **отсутствовать** в запросе.


## Получение Яндекс-капчи

Получение капчи можно разделить на несколько этапов:

+ получение captcha-key с сервера 2ch
Адрес запроса: https://2ch.hk/makaba/captcha.fcgi
Ответ сервера представлен в текстовом формате и состоит из двух строк:

```
CHECK
xxxyyyzzzxxxyyyzzz
```
где **xxxyyyzzzxxxyyyzzz** - нужный нам параметр captcha-key.

Необходимо дополнительно сохранить значение **captcha-key** для дальнейшего использования при отправке сообщения в тред.

+ Создание ссылки из captcha-key

Ссылка для запроса капча-изображения имеет вид:
http://captcha.yandex.net/image?key=xxxyyyzzzxxxyyyzzz

+ переход по ссылке и получение изображения Яндекс-капчи

Ссылку необходимо использовать как источник изображения капчи.


## Использование пасскода при работе с API

Работу по обеспечению рабочего механизма отправки сообщений через пасскод можно разделить на следующие этапы:

+ отправка пасскода на сервер двача

POST-запрос по адресу: https://2ch.hk/makaba/makaba.fcgi с параметрами:
  + task = **auth**
  + usercode = *passcode* - необходимо отправлять именно passcode, и пусть вас не смущает название параметра
+ получение в ответ **usercode**-параметр для использования в дальнейших запросах

К сожалению, как такового ответа в нормальном виде сервер не выдаст. Вместо этого он сохранит локально Cookies на устройстве и попытается перенаправить на одну из досок (обычно b).

+ сохранение **usercode**-параметра как cookie

Нас интересует cookie с названием **usercode**, необходимо самостоятельно достать его значение и сохранить локально на устройстве через соответствующий механизм.

Затем использовать этот параметр в форме как значение переменной **usercode**. а также создавать локальную cookie-переменную с именем ***usercode** и значением, соответствующим значению, полученному с сервера.

+ использование usercode-параметра при отправке сообщений

**Внимание!**  Чтобы пользователю не приходилось каждый раз прокатывать пасскод через авторизатор макабы, необходимо при каждом запуске приложения запрашивать значение из локального хранилища и формировать именно **cookie** из этих данных. Иначе API макабы не распознает наличие usercode, хотя мы и будем передавать его в форме.